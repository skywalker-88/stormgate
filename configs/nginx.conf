# Simple reverse proxy in front of StormGate (plain HTTP for dev)
limit_req_zone $binary_remote_addr zone=ip_rps:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=ip_conn:10m;

server {
  listen 8080;

  # Cheap guards
  client_body_timeout 5s;
  client_header_timeout 5s;
  send_timeout 10s;
  client_max_body_size 1m;
  keepalive_timeout 30s;

  limit_req zone=ip_rps burst=50 nodelay;
  limit_conn ip_conn 50;

  location = /favicon.ico {
    add_header Cache-Control "public, max-age=31536000, immutable";
    return 204;
  }

  location = /robots.txt {
    add_header Cache-Control "public, max-age=3600";
    return 200 "User-agent: *\nDisallow:\n";
  }

  location / {
    proxy_pass http://protector:8080;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_read_timeout 10s;
    proxy_connect_timeout 3s;
    proxy_send_timeout 10s;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Host $host;
  }
}
